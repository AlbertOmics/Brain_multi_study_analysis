---
title: "Vignette Title"
author:
- name: First Author
  affiliation: First Author's Affiliation
- name: Second Author
  affiliation: Second Author's Affiliation
  email: corresponding@author.com
package: packageName
output:
  BiocStyle::html_document
abstract: |
  Description of your vignette
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Getting started

To enable the _Bioconductor_ style in your R Markdown vignette you need to include the following in the `DESCRIPTION` file:

    VignetteBuilder: knitr
    Suggests: BiocStyle, knitr, rmarkdown


# Style macros

_BiocStyle_ introduces the following macros for referring to _R_ packages:

* `r Biocpkg("IRanges")`, for _Bioconductor_ software, annotation and experiment data packages,
* `r CRANpkg("data.table")`, for _R_ packages available on CRAN,
* `r Githubpkg("rstudio/rmarkdown")`, for _R_ packages available on GitHub,
* `r Rpackage("MyPkg")`, for _R_ packages that are _not_ available on _Bioconductor_, CRAN or GitHub.

# Code
```{r}


library(recount3)

options(recount3_url = "https://recount-opendata.s3.amazonaws.com/recount3/release") 

human_projects <- available_projects()
```


```{r}



crear_objetos_rse <- function(x) {
  rsa_gene <- create_rse_manual(
    project = x,
    project_home = "data_sources/sra",
    organism = 'mouse',
    annotation = 'gencode_v23',
    type = 'gene'
  )
  rsa_gene
}

SRA_list <- c('SRP215380',
'SRP128050',
'SRP199237',
'SRP152324',
'SRP152966',
'SRP131336',
'SRP188879',
'SRP119845',
'SRP100500',
'SRP130908',
'SRP125754',
'SRP174174',
'SRP099692'
)
#$SRP178253,SRP093683, 'SRP223471' replicas


rse_gene_list <- lapply(SRA_list, crear_objetos_rse)
names(rse_gene_list) <- SRA_list

```

# Explore information
```{r}
raw_Data <- rse_gene_list
```


```{r}
rse_gene_list <- raw_Data

assay_compute <- function(x) {
  assay(x, "counts") <- compute_read_counts(x)
  x
}

rse_gene_list <- lapply(rse_gene_list, assay_compute)

```


#
```{r}

grep_name_cols <- function(x){
  colData(x)[
      ,
      grepl("^sra_attribute", colnames(colData(x)))
  ]
}

rse_gene_list <- lapply(rse_gene_list, expand_sra_attributes)

lapply(rse_gene_list, grep_name_cols)


```
```{r}
rse_gene_list$SRP131336$sra_attribute.source_name_1 <- rse_gene_list$SRP131336$sra_attribute.source_name
colnames(colData(rse_gene_list$SRP131336))[colnames(colData(rse_gene_list$SRP131336)) == "sra_attribute.source_name_1"] <- "sra_attribute.Sex"

colnames(colData(rse_gene_list$SRP119845))[colnames(colData(rse_gene_list$SRP119845)) == "sra_attribute.source_name"] <- "sra_attribute.tissue"
colnames(colData(rse_gene_list$SRP119845))[colnames(colData(rse_gene_list$SRP119845)) == "sra_attribute.high_fat_diet"] <- "sra_attribute.genotype"

colnames(colData(rse_gene_list$SRP119845))[colnames(colData(rse_gene_list$SRP119845)) == "sra_attribute.treatment"] <- "sra_attribute.source_name"

colnames(colData(rse_gene_list$SRP130908))[colnames(colData(rse_gene_list$SRP130908)) == "sra_attribute.treatment"] <- "sra_attribute.genotype"

colnames(colData(rse_gene_list$SRP125754))[colnames(colData(rse_gene_list$SRP125754)) == "sra_attribute.agent"] <- "sra_attribute.genotype"

colData(rse_gene_list$SRP100500) <- subset(colData(rse_gene_list$SRP100500), select = -c(sra_attribute.tissue))  
colnames(colData(rse_gene_list$SRP100500))[colnames(colData(rse_gene_list$SRP100500)) == "sra_attribute.cell_type"] <- "sra_attribute.tissue"


rse_gene_list$SRP131336$sra_attribute.Sex <-  gsub('wild type_', '',rse_gene_list$SRP131336$sra_attribute.Sex )
rse_gene_list$SRP131336$sra_attribute.Sex <-  gsub('mutant_', '',rse_gene_list$SRP131336$sra_attribute.Sex )
rse_gene_list$SRP131336$sra_attribute.Sex <-  gsub('_brain', '',rse_gene_list$SRP131336$sra_attribute.Sex )

#rse_gene_list$SRP131336$sra_attribute.Sex


#SRP119845,SRP100500,SRP130908,SRP125754,SRP174174,SRP099692
add_males <- function(x){
  bool_1 <- sum(colnames(colData(x))=='sra_attribute.Sex')
  bool_2 <- sum(colnames(colData(x))=='sra_attribute.sex')
  bool_3 <- sum(colnames(colData(x))=='sra_attribute.gender')
  print(bool_1,bool_2,bool_3)
  if (!(bool_1|bool_2|bool_3)){
    x$sra_attribute.Sex <- rep('male',dim(x)[2])}
  x
  }

add_age <- function(x){
  bool_1 <- sum(colnames(colData(x))=='sra_attribute.age')
  bool_2 <- sum(colnames(colData(x))=='sra_attribute.weeks')
  bool_3 <- sum(colnames(colData(x))=='sra_attribute.developmental_stage')
  print(bool_1,bool_2,bool_3)
  if (!(bool_1|bool_2|bool_3)){
    x$sra_attribute.age <- rep('8 weeks',dim(x)[2])}
  x
  }
rse_gene_list <- lapply(rse_gene_list, add_males)
rse_gene_list <- lapply(rse_gene_list, add_age)

colnames(colData(rse_gene_list$SRP188879))[178:181] <- c("sra_attribute.tissue","sra_attribute.genotype", "sra_attribute.source_name", "sra_attribute.strain")
colData(rse_gene_list$SRP188879) <- subset(colData(rse_gene_list$SRP188879), select = -c(sra_attribute.treatment))  
colData(rse_gene_list$SRP099692) <- subset(colData(rse_gene_list$SRP099692), select = -c(sra_attribute.treatment))  
colData(rse_gene_list$SRP100500) <- subset(colData(rse_gene_list$SRP100500), select = -c(sra_attribute.tumor_status))  
colData(rse_gene_list$SRP130908) <- subset(colData(rse_gene_list$SRP130908), select = -c(sra_attribute.generation))  

rse_gene_list$SRP174174$sra_attribute.tissue <- rse_gene_list$SRP174174$sra_attribute.source_name

```


 see each colnames
```{r}
see_col_names <- function(x){
  colnames(colData(x))[grepl('sra_attribute',colnames(colData(x)))]
}

lapply(rse_gene_list, see_col_names)

```

normalize columns
```{r}
normal_column <- function(x){
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.strain/background"] <- "sra_attribute.strain"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.strain_background"] <- "sra_attribute.strain"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.gender"] <- "sra_attribute.Sex"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.tissue/cell_type"] <- "sra_attribute.tissue" 
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.genotype/variation"] <- "sra_attribute.genotype"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.high_fat_diet"] <- "sra_attribute.genotype"

  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.diet"] <- "sra_attribute.genotype"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.developmental_stage"] <- "sra_attribute.age"
  colnames(colData(x))[colnames(colData(x)) == "sra_attribute.weeks"] <- "sra_attribute.age"

  x
}

rse_gene_list <- lapply(rse_gene_list, normal_column)
lapply(rse_gene_list, see_col_names)

```
See values of age
```{r}
check_unique <- function(x){
  print(table(x$sra_attribute.age))
  print(table(x$sra_attribute.genotype))
  print(table(x$sra_attribute.Sex))    
  #print(table(x$sra_attribute.source_name)) 
  #print(table(x$sra_attribute.strain))
  print(table(x$sra_attribute.tissue))
}
lapply(rse_gene_list, check_unique)
```


```{r}
#months <- grepl('months',rse_gene_SRP040070$sra_attribute.age)
#raw_age <- rse_gene_SRP040070
#rse_gene_SRP040070$sra_attribute.age <-  gsub(' weeks old', '',rse_gene_SRP040070$sra_attribute.age )

reshape_as <- function(x){
  #x$sra_attribute.genotype <-  gsub('wild type', 'WT', x$sra_attribute.genotype )
  x$sra_attribute.age <-  factor(tolower(x$sra_attribute.age))
  #x$sra_attribute.genotype <-  factor(tolower(x$sra_attribute.genotype))
  #x$sra_attribute.Sex <-  factor(tolower(x$sra_attribute.Sex))

  #x$sra_attribute.tissue <-  factor(tolower(x$sra_attribute.tissue))
  #x$study <- factor(ifelse(x$sra_attribute.age == 'nada', "nada", metadata(x)$project))

  #x
}
lapply(rse_gene_list, reshape_as)
#rse_gene_list <- lapply(rse_gene_list, reshape_as)
```



```{r}
## Resumen de las variables de interés
get_summary <- function(x){
summary(as.data.frame(colData(x)[
    ,
    grepl("^sra_attribute.[age|Sex|genotype|tissue]", colnames(colData(x)))
]))
}

lapply(rse_gene_list, get_summary)

```
```{r}
normalize_data <- function(x){
  x$assigned_gene_prop <- x$recount_qc.gene_fc_count_all.assigned /     x$recount_qc.gene_fc_count_all.total
    print(summary(x$assigned_gene_prop))
x
}


rse_gene_list <- lapply(rse_gene_list, normalize_data)



```

```{r}
## Guardemos nuestro objeto entero por si luego cambiamos de opinión
rse_gene_unfiltered <- rse_gene_list

```

```{r}
# no hay menores a 0.3, pero si hubiera
rse_gene_list <- rse_gene_unfiltered
## Eliminemos a muestras malas 
remove_check <- function(x){
  hist(x$assigned_gene_prop)
table(x$assigned_gene_prop < 0.3)
}

lapply(rse_gene_list, remove_check)


```

```{r}

remove_failures <- function(x){
  x <- x[, x$assigned_gene_prop > 0.3]
  print(x)
  gene_means <- rowMeans(assay(x, "counts"))
  summary(gene_means)
  x
}

rse_gene_list <- lapply(rse_gene_list, remove_failures)

```

unimos los datos
```{r}
library("edgeR") # BiocManager::install("edgeR", update = FALSE)

joined_data <-  cbind(rse_gene_list$SRP215380,rse_gene_list$SRP128050,rse_gene_list$SRP199237,rse_gene_list$SRP152324, rse_gene_list$SRP131336, rse_gene_list$SRP152966, rse_gene_list$SRP100500,
                       rse_gene_list$SRP130908, rse_gene_list$SRP125754, rse_gene_list$SRP174174, rse_gene_list$SRP099692)
#, rse_gene_list$SRP119845, , rse_gene_list$SRP188879
joined_data$prenatal <- factor(ifelse(joined_data$sra_attribute.age == 'E16.5', "prenatal", "postnatal"))


joined_data$sra_attribute.tissue <-  gsub('brain', 'Brain', joined_data$sra_attribute.tissue )
joined_data$sra_attribute.tissue <-  gsub('GL261 tumor tissue, No treat control', 'Tumor', joined_data$sra_attribute.tissue )
joined_data$sra_attribute.tissue <-  gsub('Brain tumor', 'Tumor', joined_data$sra_attribute.tissue )
joined_data$sra_attribute.tissue <-  gsub('Glioma brain tumor', 'Tumor', joined_data$sra_attribute.tissue )
joined_data$sra_attribute.tissue <-  gsub('Glioma Tumor', 'Tumor', joined_data$sra_attribute.tissue )
joined_data$sra_attribute.tissue <-  gsub('tumor cells', 'Tumor', joined_data$sra_attribute.tissue )

joined_data$sra_attribute.tissue <-  gsub('Healthy Brain control', 'Brain', joined_data$sra_attribute.tissue )

  dge <- DGEList(
    counts = assay(joined_data, "counts"),
    genes = rowData(joined_data)
  )
  dge <- calcNormFactors(dge)
```


```{r}
library("ggplot2")
ggplot(as.data.frame(colData(joined_data)), aes(y = assigned_gene_prop, x = sra_attribute.Sex)) +
    geom_boxplot() +
    theme_bw(base_size = 20) +
    ylab("Assigned Gene Prop") +
    xlab("Gender Group")


```

[age|gender|tissue|cell_type|sorting_markers]

+ sra_attribute.tissue  + sra_attribute.cell_type + sra_attribute.sorting_markers  + 
[age|Sex|genotype|tissue]
```{r}
mod <- model.matrix(~ sra_attribute.Sex +  prenatal + sra_attribute.genotype + sra_attribute.tissue,
    data = colData(joined_data)
)
colnames(mod)
```

```{r}
library("limma")
vGene <- voom(dge, mod, plot = TRUE)
```
```{r}
eb_results <- eBayes(lmFit(vGene))

de_results <- topTable(
    eb_results,
    coef = 2,
    number = nrow(joined_data),
    sort.by = "none"
)
dim(de_results)
```

```{r}
head(de_results)

```
```{r}
table(de_results$adj.P.Val < 0.05)

```


```{r}
plotMA(eb_results, coef = 2)

```
```{r}
miau <- volcanoplot(eb_results, coef = 2, highlight = 20, names = de_results$gene_name)

```

[age|Sex|genotype|tissue]


```{r}
## Extraer valores de los genes de interés
exprs_heatmap <- vGene$E[rank(de_results$adj.P.Val) <= 50, ]

## Creemos una tabla con información de las muestras
## y con nombres de columnas más amigables
df <- as.data.frame(colData(joined_data)[, c("sra_attribute.Sex", "prenatal","sra_attribute.genotype","sra_attribute.tissue","study")])
colnames(df) <- c("Gender", "Prenatal", "Genotype", "Tissue", "Project")



## Hagamos un heatmap
library("pheatmap")
pheatmap(
    exprs_heatmap,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_rownames = FALSE,
    show_colnames = FALSE,
    annotation_col = df
)
```

Cambiar brain a prenatal bran
```{r}
## Extraer valores de los genes de interés
exprs_heatmap <- vGene$E[rank(de_results$adj.P.Val) <= 50, ]

## Creemos una tabla con información de las muestras
## y con nombres de columnas más amigables
df <- as.data.frame(colData(joined_data)[, c("sra_attribute.Sex","sra_attribute.tissue","prenatal")])
colnames(df) <- c("Gender", "Tissue",'Prenatal')

## Hagamos un heatmap
library("pheatmap")
pheatmap(
    exprs_heatmap,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_rownames = FALSE,
    show_colnames = FALSE,
    annotation_col = df
)



```
```{r}


```



```{r}
## Extraer valores de los genes de interés
exprs_heatmap <- vGene$E[rank(de_results$adj.P.Val) <= 50, ]

## Creemos una tabla con información de las muestras
## y con nombres de columnas más amigables
df <- as.data.frame(colData(joined_data)[, c("sra_attribute.Sex","sra_attribute.tissue")])
colnames(df) <- c("Gender",'Tissue')

df$Tissue <-  gsub('Brain; hippocampus', 'Brain', df$Tissue )
df$Tissue <-  gsub(names(table(df$Tissue)[4]), 'Brain', df$Tissue )
df$Tissue <-  gsub('Left Brain hemisphere', 'Brain', df$Tissue )
df$Tissue <-  gsub('Left Brain hemisphere', 'Brain', df$Tissue )
df$Tissue <-  gsub('GL261 tumor tissue, VEGF-A blockade,200ug mAb/ dose', 'Tumor', df$Tissue )

## Hagamos un heatmap
library("pheatmap")
pheatmap(
    exprs_heatmap,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_rownames = FALSE,
    show_colnames = FALSE,
    annotation_col = df
)
```
# Figures

Assign captions to figures in the code chunk option `fig.cap` to automatically number them, and to be able to reference them, see Figure \@ref(fig:plot). The figure label is generated from the code chunk label by prefixing it with `fig:`.



# Equations

To number and reference equations, put them in equation environments and assign labels to them, see Equation \@ref(eq:binom).

\begin{equation}
  f\left(k\right) = \binom{n}{k} p^k\left(1-p\right)^{n-k}
  (\#eq:binom)
\end{equation}


# Tables

Like figures, tables with captions will also be numbered and can be referenced, see Table \@ref(tab:table).

Fruit   | Price
------- | -----
bananas | 1.2
apples  | 1.0
oranges | 2.5

: (\#tab:table) A simple table. With caption.


# Cross-references

Apart from referencing figures (Section \@ref(figures)), tables (Section \@ref(tables)), and equations (Section \@ref(equations)), you can also use the same syntax to refer to sections by their default labels generated by pandoc.


# Side notes

Footnotes are displayed as side notes on the right margin^[this is a side note entered as a footnote], which has the advantage that they appear close to the place where they are defined.


# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
